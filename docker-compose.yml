version: "3.9"
services:
  dev:
    build:
      context: ./.devcontainer
      dockerfile: Dockerfile
    volumes:
      - ./:/workspaces/conformance-test-suite:cached
      - pnpm-store:/pnpm
      - node-modules:/workspaces/conformance-test-suite/node_modules
    working_dir: /workspaces/conformance-test-suite/certification-simple
    #command: bash -lc "corepack enable && pnpm install && pnpm run dev"
    command: "sleep infinity"
    environment:
      NODE_ENV: development
      PNPM_HOME: /pnpm
      USE_NGROK: ${USE_NGROK:-false}
      NGROK_AUTH_TOKEN: ${NGROK_AUTH_TOKEN:-}
    ports:
      - "3000:3000" # Frontend
      - "5005:5005" # API

  # Optional sidecar if you want ngrok in a container (otherwise the app can open its own tunnel)
  ngrok:
    image: ngrok/ngrok:alpine
    restart: unless-stopped
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN}
    command: http --domain=auto 5005
    depends_on:
      - dev
    profiles: ["with-ngrok"]

volumes:
  pnpm-store:
  node-modules: