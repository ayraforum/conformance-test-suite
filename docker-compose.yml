version: "3.9"
services:
  dev:
    build:
      context: ./.devcontainer
      dockerfile: Dockerfile
    volumes:
      - ./:/workspaces/conformance-test-suite:cached
      - pnpm-store:/pnpm
      - node-modules:/workspaces/conformance-test-suite/node_modules
    working_dir: /workspaces/conformance-test-suite/certification-simple
    #command: bash -lc "corepack enable && pnpm install && pnpm run dev"
    command: "sleep infinity"
    environment:
      NODE_ENV: development
      PNPM_HOME: /pnpm
      USE_NGROK: ${USE_NGROK:-false}
      NGROK_AUTH_TOKEN: ${NGROK_AUTH_TOKEN:-}
      REFERENCE_AGENT: ${REFERENCE_AGENT:-credo}
      REFERENCE_ISSUER_OVERRIDE_AGENT: ${REFERENCE_ISSUER_OVERRIDE_AGENT:-auto}
      REFERENCE_VERIFIER_OVERRIDE_AGENT: ${REFERENCE_VERIFIER_OVERRIDE_AGENT:-auto}
      ALLOW_ACAPY_ANONCREDS: ${ALLOW_ACAPY_ANONCREDS:-false}
      REFERENCE_AGENT_NGROK_DOMAIN: ${REFERENCE_AGENT_NGROK_DOMAIN:-}
      ISSUER_OVERRIDE_NGROK_DOMAIN: ${ISSUER_OVERRIDE_NGROK_DOMAIN:-}
      ISSUER_NGROK_DOMAIN: ${ISSUER_NGROK_DOMAIN:-${REFERENCE_AGENT_NGROK_DOMAIN:-}}
      ACAPY_CONTROL_URL: ${ACAPY_CONTROL_URL:-http://acapy-control:9001}
      ACAPY_PROFILE: ${ACAPY_PROFILE:-issuer}
      ACAPY_HOLDER_CONTROL_URL: ${ACAPY_HOLDER_CONTROL_URL:-http://acapy-holder-control:9003}
      ACAPY_HOLDER_PROFILE: ${ACAPY_HOLDER_PROFILE:-holder}
      ACAPY_VERIFIER_PROFILE: ${ACAPY_VERIFIER_PROFILE:-verifier}
      ACAPY_VERIFIER_CONTROL_URL: ${ACAPY_VERIFIER_CONTROL_URL:-}
      ACAPY_VERIFIER_AUTO_SEND_PROOF_REQUEST: ${ACAPY_VERIFIER_AUTO_SEND_PROOF_REQUEST:-false}
      SERVER_NGROK_DOMAIN: ${SERVER_NGROK_DOMAIN:-}
      REFERENCE_AGENT_OOB_SERVICE_ENDPOINT: ${REFERENCE_AGENT_OOB_SERVICE_ENDPOINT:-}
      INTERNAL_HOLDER_DIDCOMM_ENDPOINT: ${INTERNAL_HOLDER_DIDCOMM_ENDPOINT:-}
    ports:
      - "3000:3000" # Frontend
      - "5005:5005" # API

  app:
    build:
      context: ./.devcontainer
      dockerfile: Dockerfile
    depends_on:
      - acapy-control
      - acapy-holder-control
    volumes:
      - ./:/workspaces/conformance-test-suite:cached
      - pnpm-store:/pnpm
      - node-modules:/workspaces/conformance-test-suite/node_modules
    working_dir: /workspaces/conformance-test-suite/certification-simple
    command: >
      bash -lc '
        set -euo pipefail
        corepack enable
        pnpm install
        pnpm --filter @demo/core run build
        pnpm --filter cts-3 run start:server &
        SERVER_PID=$!
        pnpm --filter cts-3 dev &
        CLIENT_PID=$!
        trap "kill $SERVER_PID $CLIENT_PID" EXIT
        wait
      '
    environment:
      NODE_ENV: development
      PNPM_HOME: /pnpm
      USE_NGROK: ${USE_NGROK:-false}
      NGROK_AUTH_TOKEN: ${NGROK_AUTH_TOKEN:-}
      REFERENCE_AGENT: ${REFERENCE_AGENT:-credo}
      REFERENCE_ISSUER_OVERRIDE_AGENT: ${REFERENCE_ISSUER_OVERRIDE_AGENT:-auto}
      REFERENCE_VERIFIER_OVERRIDE_AGENT: ${REFERENCE_VERIFIER_OVERRIDE_AGENT:-auto}
      ALLOW_ACAPY_ANONCREDS: ${ALLOW_ACAPY_ANONCREDS:-false}
      REFERENCE_AGENT_NGROK_DOMAIN: ${REFERENCE_AGENT_NGROK_DOMAIN:-}
      ISSUER_OVERRIDE_NGROK_DOMAIN: ${ISSUER_OVERRIDE_NGROK_DOMAIN:-}
      ISSUER_NGROK_DOMAIN: ${ISSUER_NGROK_DOMAIN:-${REFERENCE_AGENT_NGROK_DOMAIN:-}}
      ACAPY_CONTROL_URL: ${ACAPY_CONTROL_URL:-http://acapy-control:9001}
      ACAPY_PROFILE: ${ACAPY_PROFILE:-issuer}
      ACAPY_HOLDER_PROFILE: ${ACAPY_HOLDER_PROFILE:-holder}
      ACAPY_VERIFIER_PROFILE: ${ACAPY_VERIFIER_PROFILE:-verifier}
      ACAPY_VERIFIER_CONTROL_URL: ${ACAPY_VERIFIER_CONTROL_URL:-}
      ACAPY_VERIFIER_AUTO_SEND_PROOF_REQUEST: ${ACAPY_VERIFIER_AUTO_SEND_PROOF_REQUEST:-false}
      SERVER_NGROK_DOMAIN: ${SERVER_NGROK_DOMAIN:-}
      ACAPY_ENDPOINT: ${ACAPY_ENDPOINT:-http://acapy-control:8041}
      ACAPY_INVITE_BASE_URL: ${ACAPY_INVITE_BASE_URL:-http://acapy-control:8041}
      ACAPY_HOLDER_CONTROL_URL: ${ACAPY_HOLDER_CONTROL_URL:-http://acapy-holder-control:9003}
      ACAPY_HOLDER_ENDPOINT: ${ACAPY_HOLDER_ENDPOINT:-http://acapy-holder-control:8043}
      ACAPY_HOLDER_INVITE_BASE_URL: ${ACAPY_HOLDER_INVITE_BASE_URL:-http://acapy-holder-control:8043}
      ACAPY_AUTO_SEND_INVITE_TO_INTERNAL_HOLDER: ${ACAPY_AUTO_SEND_INVITE_TO_INTERNAL_HOLDER:-false}
      REFERENCE_AGENT_OOB_SERVICE_ENDPOINT: ${REFERENCE_AGENT_OOB_SERVICE_ENDPOINT:-}
      INTERNAL_HOLDER_DIDCOMM_ENDPOINT: ${INTERNAL_HOLDER_DIDCOMM_ENDPOINT:-}
      NEXT_PUBLIC_TRQP_KNOWN_ENDPOINT: ${NEXT_PUBLIC_TRQP_KNOWN_ENDPOINT:-}
      NEXT_PUBLIC_TRQP_LOCAL_URL: ${NEXT_PUBLIC_TRQP_LOCAL_URL:-}
    ports:
      - "3000:3000"
      - "5005:5005"

  acapy-control:
    build:
      context: ./certification-simple/services/acapy-control
    volumes:
      # TEMP: expose local Ayra context until hosted at a stable URL
      - ./certification-simple/packages/cts/schema:/app/schema:ro
    ports:
      - "9001:9001"
      - "8041:8041"
      - "8042:8042"
    environment:
      PYTHONUNBUFFERED: "1"
      REFERENCE_AGENT_NGROK_DOMAIN: ${REFERENCE_AGENT_NGROK_DOMAIN:-}
      VERIFIER_TEST_NGROK_DOMAIN: ${VERIFIER_TEST_NGROK_DOMAIN:-}
      ISSUER_NGROK_DOMAIN: ${ISSUER_NGROK_DOMAIN:-${REFERENCE_AGENT_NGROK_DOMAIN:-}}
      VERIFIER_NGROK_DOMAIN: ${VERIFIER_NGROK_DOMAIN:-${VERIFIER_TEST_NGROK_DOMAIN:-}}
      ACAPY_ENDPOINT: ${ACAPY_ENDPOINT:-}
      ACAPY_INVITE_BASE_URL: ${ACAPY_INVITE_BASE_URL:-}
      ACAPY_ADMIN_HOST: ${ACAPY_ADMIN_HOST:-acapy-control}
      ACAPY_PROFILE: ${ACAPY_PROFILE:-issuer}

  acapy-holder-control:
    build:
      context: ./certification-simple/services/acapy-control
    volumes:
      # TEMP: expose local Ayra context until hosted at a stable URL
      - ./certification-simple/packages/cts/schema:/app/schema:ro
    ports:
      - "9003:9003"
      - "8043:8043"
    environment:
      PYTHONUNBUFFERED: "1"
      ACAPY_ADMIN_HOST: ${ACAPY_HOLDER_ADMIN_HOST:-acapy-holder-control}
      ACAPY_PROFILE: ${ACAPY_HOLDER_PROFILE:-holder}
      ACAPY_ENDPOINT: ${ACAPY_HOLDER_ENDPOINT:-http://acapy-holder-control:8043}
      ACAPY_INVITE_BASE_URL: ${ACAPY_HOLDER_INVITE_BASE_URL:-http://acapy-holder-control:8043}
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "9003"]

  acapy-verifier-control:
    build:
      context: ./certification-simple/services/acapy-control
    volumes:
      # TEMP: expose local Ayra context until hosted at a stable URL
      - ./certification-simple/packages/cts/schema:/app/schema:ro
    ports:
      - "9010:9010"
      - "8142:8042"
    environment:
      PYTHONUNBUFFERED: "1"
      ACAPY_ADMIN_HOST: ${ACAPY_VERIFIER_ADMIN_HOST:-acapy-verifier-control}
      ACAPY_PROFILE: ${ACAPY_VERIFIER_PROFILE:-verifier}
      ACAPY_ENDPOINT: ${ACAPY_VERIFIER_ENDPOINT:-http://acapy-verifier-control:8042}
      ACAPY_INVITE_BASE_URL: ${ACAPY_VERIFIER_INVITE_BASE_URL:-http://acapy-verifier-control:8042}
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "9010"]

  acapy-ngrok:
    image: ngrok/ngrok:alpine
    depends_on:
      - acapy-control
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN:-}
      REFERENCE_AGENT_NGROK_DOMAIN: ${REFERENCE_AGENT_NGROK_DOMAIN:-${ISSUER_NGROK_DOMAIN:-}}
      ISSUER_NGROK_DOMAIN: ${ISSUER_NGROK_DOMAIN:-${REFERENCE_AGENT_NGROK_DOMAIN:-}}
      NGROK_REGION: ${NGROK_REGION:-us}
    entrypoint: []
    command:
      - /bin/sh
      - -c
      - |
        set -euo pipefail
        REF_DOMAIN="$${REFERENCE_AGENT_NGROK_DOMAIN}"
        if [ -z "$$REF_DOMAIN" ]; then
          REF_DOMAIN="$${ISSUER_NGROK_DOMAIN}"
        fi
        if [ -z "$$REF_DOMAIN" ]; then
          echo 'REFERENCE_AGENT_NGROK_DOMAIN (or ISSUER_NGROK_DOMAIN) must be set (e.g. reference-xxx.ngrok.app)' >&2
          exit 1
        fi
        exec ngrok http --region="$${NGROK_REGION}" --domain="$$REF_DOMAIN" http://acapy-control:8041

  # Optional sidecar if you want ngrok in a container (otherwise the app can open its own tunnel)
  ngrok:
    image: ngrok/ngrok:alpine
    restart: unless-stopped
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTH_TOKEN}
    command: http --domain=auto 5005
    depends_on:
      - dev
    profiles: ["with-ngrok"]

volumes:
  pnpm-store:
  node-modules:
